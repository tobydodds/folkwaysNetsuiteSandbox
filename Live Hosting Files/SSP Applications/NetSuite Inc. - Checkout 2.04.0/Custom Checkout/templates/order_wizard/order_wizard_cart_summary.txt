<%
	var current_position = view.wizard.getStepPosition()
	,	cart = view.wizard.model
	,	application = view.wizard.application
	,	current_symbol = application.getConfig('siteSettings.shopperCurrency.symbol','') //Automation purpose
	,	summary = cart.get('summary')
	,	promocode = cart.get('promocode')
	,	membercode = cart.get('promocode')	
	,	ismultishipto = cart.get('ismultishipto')
	,	item_count = _.reduce(cart.get('lines').pluck('quantity'), function (memo, quantity) { return memo + (parseFloat(quantity) || 1); }, 0)
	,	is_promocode_valid = promocode && promocode.isvalid
	,	is_member_valid = membercode && membercode.isvalid		
	,	giftcertificates = cart.get('paymentmethods').where({type: 'giftcertificate'}) || [];
%>
<div class="checkout-cart-summary">
	<header class="checkout-cart-summary-header">
		<% if (current_position.toLast > 0) { %>
			<div class="edit-cart-label">
				<a href="#" class="btn btn-link btn-edit-cart" data-touchpoint="viewcart">
					<%= _('Edit Order').translate() %>
				</a>
			</div>
		<% } %>	
		<h3 style="font-size: 29.25px;" class="checkout-cart-summary-title">
			<%= _('Order Summary').translate() %>
		</h3>
	</header>
	
	<div class="checkout-cart-summary-body">
		<% if (!view.getHideItems()) { %>
			<ul class="cart-summary-items checkout-summary-items">
			<%
				var thumbnail = ''
				,	item = null;
			%>
			<% cart.get('lines').each(function (line) { %>
				<%
					item = line.get('item');
					thumbnail = item.get('_thumbnail');
				%>
				<li class="cart-summary-item-cell checkout-summary-item-cell">
					<div class="row-fluid">
						<div class="span3 thumbnail checkout-summary-item-thumbnail">
							<img src="<%- application.resizeImage(thumbnail.url, 'tinythumb') %>" alt="<%- thumbnail.altimagetext %>">
						</div>
						<div class="span9 cart-summary-item-details checkout-summary-item-details">
							<div style="font-family:Verdana;"  class="pull-right cart-summary-item-total">
								<%= line.get('total_formatted') %>
								<% if (line.get('amount') > line.get('total')) {%>
									<small class="muted crossed cart-summary-item-amount">
										<%=  line.get('amount_formatted') %>
									</small>
								<% } %>
							</div>
							<div>
								<a href="<%= item.get('custitem_catalog_itemurl')%>">
									<strong style="font-family: Georiga;font-weight: bold;font-size: 16px;" class="cart-summary-item-name"><%= item.get('displayname') %></strong>
								</a>
							</div>
							<div>
							<p style="font-family: Verdana, Geneva, sans-serif;font-size: 12px;" class="cart-summary-item-sku"><%= item.get('storedescription') %></p>
						</div>
							<div style="font-family: Verdana, Geneva, sans-serif;font-size: 12px;" class="cart-summary-item-quantity">
								<%= _('Qty: $(0)').translate(line.get('quantity')) %>
							</div>
							<div class="cart-summary-item-price">
								<%= SC.macros.showItemPrice(line.getPrice()) %>
							</div>
							<%= /* Renders the selected options for the item */
								item.renderAllOptionSelected() %>
						</div>
					</div>
				</li>
			<% }) %>
			</ul>
		<% } %>
		<div class="cart-summary-subtotal">
			<p class="strong">
				<span style="font-weight: bold;font-family: Verdana, Geneva, sans-serif;" class="pull-right cart-summary-subtotal-formatted" >
					<%= summary.subtotal_formatted %>
				</span>
				<span style="font-weight: bold;font-family: Verdana, Geneva, sans-serif;" class="cart-summary-subtotal-label">
					<%= _('Subtotal (<span data-type="cart-summary-subtotal-count">$(0)</span> $(1))').translate(item_count, item_count === 1 ? _('item').translate() : _('items').translate()) %>
				</span>
			</p>
		</div>

		<% if (is_promocode_valid || summary.giftcertapplied) { %>

			<% if (is_promocode_valid) { %>
				<div class="cart-summary-promocode-applied">
					<p>
						<strong class="lead-price pull-right"><%= summary.discountrate_formatted %></strong>
						<% if (promocode.code == "SIMEMBER" ) { %><%= _('Member Discount').translate() %><% } else { %><%= _('Promo Code Discount').translate() %><% } %> <a href="#" data-action="remove-promocode"><i class="icon-remove"></i></a>
					</p>
				</div>
			<% } %>

			<% if (summary.discounttotal) { %>
				<div class="cart-summary-discount-applied">
					<p>
						<span class="pull-right">
							<%= summary.discounttotal_formatted %>
						</span>
						<%= _('Discount Total').translate() %>
					</p>
				</div>
			<% } %>

			<% if (summary.giftcertapplied) { %>
				<div class="cart-summary-giftcertificate-applied">
				<p>
					<%= _('Gift Certificates Applied ($(0))').translate(giftcertificates.length) %>
				</p>
				<% _.each(giftcertificates, function (giftCertificate) { %>
					<p>
						<span class="pull-right">
							<%= _('-$(0)').translate(giftCertificate.get('giftcertificate').amountapplied_formatted) %>
						</span>
						<span title="<%- giftCertificate.get('giftcertificate').code %>">
							<%= SC.macros.formatPaymentMethod(giftCertificate) %>
						</span>
					</p>
				<% }); %>
				</div>
			<% } %>
		<% } %>

		<div class="cart-summary-shipping-cost-applied">
			<% if (summary.handlingcost) { %>
                <p>
                	<span class="pull-right cart-summary-handling-cost-formatted">
                		<%= _.formatCurrency(summary.handlingcost + summary.shippingcost)%>
                	</span>
                        <%= _('Shipping').translate() %> and <%= _('Handling').translate() %>
                </p>
            <% } else {%>
            	<p>
                    <span class="pull-right cart-summary-shipping-cost-formatted">
                        <%= summary.shippingcost_formatted %>
                    </span>
                        <%= _('Shipping').translate() %>
                </p>
            <%} %>
            <!--<p>
                    <span class="pull-right cart-summary-tax-total-formatted">
                        <%= summary.taxtotal_formatted %>
                    </span>
                        <%= _('Tax').translate() %>
                </p>-->
		</div>

		<div class="cart-summary-total">
			<p class="strong">
				<span style="font-weight: bold;font-family: Verdana, Geneva, sans-serif;" class="pull-right cart-summary-total-formatted" >
					<%= summary.total_formatted %>
				</span>
				<%= _('Total').translate() %>
			</p>
		</div>

		<% if (current_position.toLast === 1) { %>
			<div>
				<% if (SC.ENVIRONMENT.siteSettings.checkout.requiretermsandconditions === 'T') { %>
					<p><%= _('By placing your order, you are agreeing to our <a data-type="term-condition-link-summary" data-toggle="show-terms-summary" href="#">Terms & Conditions</a>').translate() %></p><br/>
				<% } %>
				<button class="btn btn-primary btn-large btn-place-order hidden-phone hidden-tablet" data-action="submit-step">
					<%= view.getContinueButtonLabel() %>
				</button>
			</div>
		<% } %>
	</div>

	<% if (!is_promocode_valid && current_position.toLast > 0) { %>
		<footer class="checkout-cart-summary-footer accordion">
			<div class="collapsible">
				<p style="font-family: Verdana, Geneva, sans-serif;" class="collapser collapsed" data-target="#promo-code-container" data-toggle="collapse">
					<i class="icon-minus-sign pull-right"></i>
					<i class="icon-plus-sign pull-right"></i>
					<%= _('Have a Promo Code?').translate() %>
					<i class="icon-question-sign"
						data-toggle="tooltip"
						title="<%= _('<b>Promo Code</b><br>To redeem a promo code, simply enter your information and we will apply the offer to your purchase during checkout.').translate() %>">
					</i>
				</p>
				<div id="promo-code-container" class="collapse promo-code-container">
					<% if(!ismultishipto){ %>
						<%= SC.macros.promocodeForm(promocode) %>
					<% } else { %>
						<div class="promocode-unsupported-summary-warning">
							<p>
								<%= _('Shipping to multiple addresses does not support Promo Codes.').translate() %>
							</p>
							<p>
								<%= _('If you want to apply one, please <a href="#" data-action="change-status-multishipto-sidebar" data-type="multishipto">ship to a single address</a>.').translate() %>
							</p>
						</div>
					<% } %>
				</div>
			</div>
		</footer>
	<% } %>
	
	<% if (!is_member_valid && current_position.toLast > 0) { %>
	<footer class="checkout-cart-summary-footer accordion">
		<div class="collapsible">
			<div class="collapsible well-section cart-summary-member-section" style="padding:0px;">
				<p style="font-family: Verdana, Geneva, sans-serif;" class="collapser collapsed" data-target="#member-code-container" data-toggle="collapse">					
					<i class="icon-minus-sign pull-right"></i>
					<i class="icon-plus-sign pull-right"></i>
					<%= _('Are you an SI Associate?').translate() %> <i data-toggle="tooltip" title="<%= _('<b>SI Associates</b><br>National Associate Members receive a 10% discount.  Enter your member code below.').translate() %>" class="icon-question-sign"></i>					
				</p>
				<div id="member-code-container" class="collapse member-code-container" style="padding: 0 18px;">
					<%= SC.macros.membercodeForm( membercode ) %>
                <p class="small">
                    If you'd like to become an SI Associate, please <a href="http://www.smithsonian.com/folkways/join" target="_blank">click here</a> to join and get your member number to save 10%.
                </p>
				</div>
			</div>
                 </div>
	</footer>
	<% } %>		
</div>